


<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบตรวจสอบรถ Emergency</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
      
        :root {
            --primary: #4dd0b6;
            --primary-light: #a8ede0;
            --primary-dark: #38a08e;
            --secondary: #f8f9fa;
            --text-dark: #343a40;
            --text-light: #6c757d;
            --danger: #dc3545;
            --danger-light: #f8d7da;
            --warning: #ffc107;
            --warning-light: #fff3cd;
            --info: #0dcaf0;
            --info-light: #d1ecf1;
        }
        
        body {
            font-family: 'Prompt', 'Kanit', sans-serif;
            background-color: #f5f9f8;
            color: var(--text-dark);
            font-size: 14px;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            font-weight: 700;
            color: white !important;
        }
        
        .card {
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: white;
            font-weight: 600;
            border: none;
            padding: 12px 16px;
            font-size: 15px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }
        
        .btn-outline-primary {
            color: var(--primary);
            border-color: var(--primary);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        
        .table {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            font-size: 13px;
        }
        
        .table thead {
            background-color: var(--primary-light);
            color: var(--text-dark);
            font-size: 13px;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(77, 208, 182, 0.05);
        }
        
        .action-btn {
            width: 32px;
            height: 32px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            margin: 0 2px;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
        }
        
        .action-btn.btn-info {
            background-color: var(--info);
            border-color: var(--info);
            color: white;
        }
        
        .action-btn.btn-warning {
            background-color: var(--warning);
            border-color: var(--warning);
            color: var(--text-dark);
        }
        
        .action-btn.btn-danger {
            background-color: var(--danger);
            border-color: var(--danger);
            color: white;
        }
        
        .filter-section {
            background-color: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            font-size: 13px;
        }
        
        .modal-content {
            border-radius: 12px;
            border: none;
            overflow: hidden;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: white;
            border: none;
            padding: 12px 16px;
        }
        
        .modal-title {
            font-weight: 600;
            font-size: 16px;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.25rem rgba(77, 208, 182, 0.25);
        }
        
        .badge-section {
            background-color: var(--primary-light);
            color: var(--text-dark);
            padding: 6px 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-weight: 600;
            font-size: 13px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--primary-light);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .section-title {
            color: var(--primary-dark);
            font-weight: 600;
            margin-bottom: 12px;
            border-bottom: 2px solid var(--primary-light);
            padding-bottom: 6px;
            font-size: 15px;
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 8px;
            font-size: 18px;
        }
        
        .detail-row {
            margin-bottom: 6px;
            padding-bottom: 6px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 13px;
            display: flex;
            align-items: center;
        }
        
        .detail-label i {
            margin-right: 6px;
            font-size: 14px;
            color: var(--primary);
        }
        
        .detail-value {
            color: var(--text-light);
            font-size: 13px;
        }
        
        .detail-value.check {
            color: #28a745;
            font-weight: 600;
        }
        
        .detail-value.number {
            color: #0d6efd;
            font-weight: 600;
        }
        
        .detail-value.text {
            color: var(--text-dark);
        }
        
        .no-data {
            text-align: center;
            padding: 30px 0;
            color: var(--text-light);
            font-size: 14px;
        }
        
        .no-data i {
            font-size: 40px;
            margin-bottom: 12px;
            color: var(--primary-light);
        }
        
        .form-label {
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
        }
        
        .form-label i {
            margin-right: 6px;
            color: var(--primary);
        }
        
        .form-control, .form-select {
            font-size: 13px;
        }
        
        .modal-body {
            font-size: 13px;
        }
        
        .form-check-label {
            font-size: 13px;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 13px;
            margin-top: 8px;
            padding: 8px;
            background-color: #f8d7da;
            border-radius: 4px;
            display: none;
        }
        
        .connection-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .connection-status.success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .connection-status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .connection-status.warning {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .password-modal .modal-header {
            background: linear-gradient(135deg, #ff9a9e, #dc3545);
        }
        
        .password-modal .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        
        .password-modal .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }
        
        .password-input {
            letter-spacing: 8px;
            font-size: 18px;
            text-align: center;
            font-weight: bold;
        }
        
        .tier-icon {
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-light);
            color: var(--primary-dark);
            border-radius: 50%;
            margin-right: 8px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .header-container {
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-title {
            font-size: 20px;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
        }
        
        .header-title i {
            margin-right: 10px;
            font-size: 24px;
        }
        
        @media (max-width: 768px) {
            .card-header {
                padding: 10px 12px;
            }
            
            .filter-section {
                padding: 12px;
            }
            
            .table-responsive {
                border-radius: 8px;
                overflow: hidden;
            }
        }
      
    </style>
  
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div class="container mt-3 mb-4">
        <div class="header-container">
            <h1 class="header-title">
                <i class="bi bi-ambulance"></i>
                ระบบตรวจสอบรถ Emergency
            </h1>
            <button id="refreshBtn" class="btn btn-sm btn-light">
                <i class="bi bi-arrow-clockwise me-1"></i> รีเฟรช
            </button>
        </div>

        <div class="row mb-3">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <div id="connectionStatus" class="connection-status warning">
                            <i class="bi bi-hourglass-split me-1"></i>
                            กำลังเชื่อมต่อกับฐานข้อมูล...
                        </div>
                        
                        <div id="errorMessage" class="error-message mb-3">
                            <i class="bi bi-exclamation-triangle-fill me-1"></i>
                            <span id="errorText">เกิดข้อผิดพลาดในการโหลดข้อมูล</span>
                        </div>
                        
                        <div class="filter-section mb-3">
                            <div class="row">
                                <div class="col-md-4 mb-2 mb-md-0">
                                    <label for="yearFilter" class="form-label">
                                        <i class="bi bi-calendar-year"></i> ปี
                                    </label>
                                    <select class="form-select form-select-sm" id="yearFilter">
                                        <option value="">ทั้งหมด</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-2 mb-md-0">
                                    <label for="monthFilter" class="form-label">
                                        <i class="bi bi-calendar-month"></i> เดือน
                                    </label>
                                    <select class="form-select form-select-sm" id="monthFilter">
                                        <option value="">ทั้งหมด</option>
                                        <option value="1">มกราคม</option>
                                        <option value="2">กุมภาพันธ์</option>
                                        <option value="3">มีนาคม</option>
                                        <option value="4">เมษายน</option>
                                        <option value="5">พฤษภาคม</option>
                                        <option value="6">มิถุนายน</option>
                                        <option value="7">กรกฎาคม</option>
                                        <option value="8">สิงหาคม</option>
                                        <option value="9">กันยายน</option>
                                        <option value="10">ตุลาคม</option>
                                        <option value="11">พฤศจิกายน</option>
                                        <option value="12">ธันวาคม</option>
                                    </select>
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button class="btn btn-primary btn-sm w-100" id="filterBtn">
                                        <i class="bi bi-funnel-fill me-1"></i> กรองข้อมูล
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="dataTable">
                                <thead>
                                    <tr>
                                        <th scope="col" width="40%">ID</th>
                                        <th scope="col" width="20%">ผู้ตรวจสอบ</th>
                                        <th scope="col" width="40%" class="text-center">จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="noData" class="no-data d-none">
                            <i class="bi bi-file-earmark-x"></i>
                            <p>ไม่พบข้อมูล</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-clipboard2-data me-2"></i>
                        รายละเอียดการตรวจสอบ
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detailModalBody">
                    <!-- Detail content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil-square me-2"></i>
                        แก้ไขข้อมูลการตรวจสอบ
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editRowIndex">
                        <!-- Form fields will be generated dynamically -->
                        <div id="editFormContent"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary btn-sm" id="saveChangesBtn">
                        <i class="bi bi-save me-1"></i> บันทึกการเปลี่ยนแปลง
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Password Modal for Delete -->
    <div class="modal fade password-modal" id="passwordModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-shield-lock me-2"></i>
                        ยืนยันรหัสผ่าน
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-center mb-3">กรุณาใส่รหัสผ่านเพื่อลบข้อมูล</p>
                    <input type="password" id="deletePassword" class="form-control password-input" maxlength="4" placeholder="****">
                    <div id="passwordError" class="text-danger text-center mt-2" style="display: none;">
                        รหัสผ่านไม่ถูกต้อง
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-danger btn-sm" id="confirmDeleteBtn">
                        <i class="bi bi-trash me-1"></i> ลบข้อมูล
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API URLs - primary and fallback
        const API_URL = 'https://script.google.com/macros/s/AKfycbyoW3ay6dJIrpkVXdCJ4jBm1VeRD5J-UuCBpc8JuRF0lo3s01WsgeP956ORhMoQuUIV/exec';
        const JSONP_URL = API_URL + '?callback=processJsonpData';
        
        // Global variables
        let allData = [];
        let filteredData = [];
        let deleteRowIndex = -1;
        
        // Column definitions - Updated according to the new specifications
        const columnDefinitions = {
            tier1: [
                { id: 'G', name: 'Adrenaline', type: 'number', icon: 'bi-capsule' },
                { id: 'H', name: 'Amiodarone', type: 'number', icon: 'bi-capsule' },
                { id: 'I', name: 'Atropine', type: 'number', icon: 'bi-capsule' },
                { id: 'J', name: 'Adenosine', type: 'number', icon: 'bi-capsule' },
                { id: 'K', name: 'Calcium Gluconate', type: 'number', icon: 'bi-capsule' },
                { id: 'L', name: 'Glucose', type: 'number', icon: 'bi-capsule' },
                { id: 'M', name: 'MgSO4', type: 'number', icon: 'bi-capsule' },
                { id: 'N', name: 'NaHCO8', type: 'number', icon: 'bi-capsule' },
                { id: 'O', name: 'Valium', type: 'number', icon: 'bi-capsule' },
                { id: 'P', name: 'Syringe', type: 'number', icon: 'bi-droplet' },
                { id: 'Q', name: 'เข็มฉีดยา', type: 'number', icon: 'bi-droplet' }
            ],
            tier2: [
                { id: 'S', name: 'IV Catheter No. 24, 22, 20, 18 อย่างละ 3', type: 'text', icon: 'bi-bandaid' },
                { id: 'T', name: '0.9 % NSS 1,000 ml 1 ขวด', type: 'text', icon: 'bi-droplet-fill' },
                { id: 'U', name: 'Set IV 3 set', type: 'text', icon: 'bi-droplet-half' },
                { id: 'V', name: 'Extension Tube 3 set', type: 'text', icon: 'bi-bandaid-fill' },
                { id: 'W', name: 'Three - way 3 อัน', type: 'text', icon: 'bi-three-dots' },
                { id: 'X', name: 'Transpore 1 นิ้ว 1ม้วน', type: 'text', icon: 'bi-bandaid' },
                { id: 'Y', name: 'Tourniquet', type: 'text', icon: 'bi-bandaid-fill' },
                { id: 'Z', name: 'กรรไกร 1', type: 'text', icon: 'bi-scissors' },
                { id: 'AA', name: 'ชามรูปไต, ไฟฉาย, แว่นตา อย่างละ 1', type: 'text', icon: 'bi-egg-fill' }
            ],
            tier3: [
                { id: 'AC', name: 'ET-Tube No.7, 7.5, 8.0 อย่างละ 2', type: 'text', icon: 'bi-lungs' },
                { id: 'AD', name: 'Laryngoscope + Blade (พร้อมถ่าน) 1 ชุด', type: 'text', icon: 'bi-tools' },
                { id: 'AE', name: 'Guide wire, Magill Forceps อย่างละ 1', type: 'text', icon: 'bi-bezier' },
                { id: 'AF', name: 'Oropharyngeal Airway 2 อัน', type: 'text', icon: 'bi-lungs-fill' },
                { id: 'AG', name: 'K-Y Jelly 1', type: 'text', icon: 'bi-droplet-half' },
                { id: 'AH', name: 'สาย Suction No.14, 16 อย่างละ 1', type: 'text', icon: 'bi-hose' },
                { id: 'AI', name: 'พลาสเตอร์เหนียวติด Tube', type: 'text', icon: 'bi-bandaid' }
            ],
            tier4: [
                { id: 'AK', name: 'ถุงมือและ Mask อย่างละ 2', type: 'text', icon: 'bi-lungs' },
                { id: 'AL', name: 'กระดานและปากกา อย่างละ 1 ชุด', type: 'text', icon: 'bi-tools' },
                { id: 'AM', name: 'ใบ CPR reccord 1 ชุด', type: 'text', icon: 'bi-bezier' },
                { id: 'AN', name: 'Stecthoscope 1 ชุด', type: 'text', icon: 'bi-lungs-fill' },
                { id: 'AO', name: 'Ambubag + Mask 1 ชุด', type: 'text', icon: 'bi-droplet-half' },
                { id: 'AP', name: 'O2 Mask c bag 1 ชุด', type: 'text', icon: 'bi-hose' },
                { id: 'AQ', name: 'O2 cannular 1 ชุด', type: 'text', icon: 'bi-bandaid' },
                { id: 'AR', name: 'สายต่อออกซิเจน 1 เส้น', type: 'text', icon: 'bi-hose' },
                { id: 'AS', name: 'CPR Board', type: 'text', icon: 'bi-clipboard-heart' }
            ],
            info: [
                { id: 'AT', name: 'ผู้ตรวจสอบ', type: 'text', icon: 'bi-person-badge' },
                { id: 'AU', name: 'เซ็นต์ชื่อ', type: 'text', icon: 'bi-pen-fill' }
            ]
        };
        
        // DOM elements
        const loadingElement = document.getElementById('loading');
        const tableBodyElement = document.getElementById('tableBody');
        const noDataElement = document.getElementById('noData');
        const yearFilterElement = document.getElementById('yearFilter');
        const monthFilterElement = document.getElementById('monthFilter');
        const filterBtnElement = document.getElementById('filterBtn');
        const refreshBtnElement = document.getElementById('refreshBtn');
        const detailModalElement = document.getElementById('detailModal');
        const detailModalBodyElement = document.getElementById('detailModalBody');
        const editModalElement = document.getElementById('editModal');
        const editFormContentElement = document.getElementById('editFormContent');
        const editRowIndexElement = document.getElementById('editRowIndex');
        const saveChangesBtnElement = document.getElementById('saveChangesBtn');
        const errorMessageElement = document.getElementById('errorMessage');
        const errorTextElement = document.getElementById('errorText');
        const connectionStatusElement = document.getElementById('connectionStatus');
        const passwordModalElement = document.getElementById('passwordModal');
        const deletePasswordElement = document.getElementById('deletePassword');
        const passwordErrorElement = document.getElementById('passwordError');
        const confirmDeleteBtnElement = document.getElementById('confirmDeleteBtn');
        
        // Bootstrap modal instances
        let detailModal;
        let editModal;
        let passwordModal;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Bootstrap modals
            detailModal = new bootstrap.Modal(detailModalElement);
            editModal = new bootstrap.Modal(editModalElement);
            passwordModal = new bootstrap.Modal(passwordModalElement);
            
            // Set current month in filter
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1;
            monthFilterElement.value = currentMonth;
            
            // Load data
            fetchData();
            
            // Event listeners
            filterBtnElement.addEventListener('click', applyFilters);
            refreshBtnElement.addEventListener('click', fetchData);
            saveChangesBtnElement.addEventListener('click', saveChanges);
            confirmDeleteBtnElement.addEventListener('click', confirmDelete);
            
            // Password input handling
            deletePasswordElement.addEventListener('input', function() {
                passwordErrorElement.style.display = 'none';
                if (this.value.length === 4) {
                    this.blur(); // Remove focus when 4 digits entered
                }
            });
        });
        
        // Global callback function for JSONP
        window.processJsonpData = function(data) {
            if (data && data.data) {
                processData(data.data);
                updateConnectionStatus('success', 'เชื่อมต่อสำเร็จ (JSONP)');
            } else {
                showError('รูปแบบข้อมูลไม่ถูกต้อง');
                updateConnectionStatus('error', 'รูปแบบข้อมูลไม่ถูกต้อง');
            }
            hideLoading();
        };
        
        // Fetch data using multiple methods
        function fetchData() {
            showLoading();
            hideError();
            updateConnectionStatus('warning', 'กำลังเชื่อมต่อกับฐานข้อมูล...');
            
            // Try different methods to fetch data
            fetchWithJsonp();
        }
        
        // Fetch with JSONP method
        function fetchWithJsonp() {
            // Remove any existing script tag
            const oldScript = document.getElementById('jsonp-script');
            if (oldScript) {
                document.head.removeChild(oldScript);
            }
            
            // Create a new script tag
            const script = document.createElement('script');
            script.id = 'jsonp-script';
            script.src = JSONP_URL + '&t=' + new Date().getTime();
            script.onerror = function() {
                console.error('JSONP request failed');
                fetchWithFetch();
            };
            
            // Add script to the document
            document.head.appendChild(script);
            
            // Set a timeout in case the JSONP request doesn't respond
            setTimeout(function() {
                if (document.getElementById('jsonp-script') === script) {
                    console.log('JSONP request timed out, trying fetch');
                    fetchWithFetch();
                }
            }, 5000);
        }
        
        // Fetch with regular fetch API
        async function fetchWithFetch() {
            try {
                const response = await fetch(API_URL + '?t=' + new Date().getTime(), {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.data) {
                        processData(data.data);
                        updateConnectionStatus('success', 'เชื่อมต่อสำเร็จ (Fetch)');
                    } else {
                        throw new Error("Invalid data format");
                    }
                } else {
                    throw new Error("HTTP error " + response.status);
                }
            } catch (error) {
                console.error('Fetch failed:', error);
                fetchWithXhr();
            } finally {
                hideLoading();
            }
        }
        
        // Fetch with XMLHttpRequest
        function fetchWithXhr() {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', API_URL + '?t=' + new Date().getTime(), true);
            xhr.setRequestHeader('Accept', 'application/json');
            
            xhr.onload = function() {
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        if (data && data.data) {
                            processData(data.data);
                            updateConnectionStatus('success', 'เชื่อมต่อสำเร็จ (XHR)');
                        } else {
                            throw new Error("Invalid data format");
                        }
                    } catch (e) {
                        showError('รูปแบบข้อมูลไม่ถูกต้อง: ' + e.message);
                        updateConnectionStatus('error', 'รูปแบบข้อมูลไม่ถูกต้อง');
                    }
                } else {
                    showError('ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้: HTTP error ' + xhr.status);
                    updateConnectionStatus('error', 'ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้');
                }
                hideLoading();
            };
            
            xhr.onerror = function() {
                showError('ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้');
                updateConnectionStatus('error', 'ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้');
                hideLoading();
            };
            
            xhr.send();
        }
        
        // Process data after fetching
        function processData(data) {
            console.log("Data received:", data);
            
            // Make sure data is an array
            if (!Array.isArray(data)) {
                showError('รูปแบบข้อมูลไม่ถูกต้อง: ข้อมูลไม่ใช่อาร์เรย์');
                return;
            }
            
            // Filter out empty rows
            allData = data.filter(row => {
                return Array.isArray(row) && row.length > 0 && row[0] !== null && row[0] !== undefined && row[0] !== '';
            });
            
            console.log("Processed data:", allData);
            
            // Populate year filter
            populateYearFilter();
            
            // Apply initial filters (current month/year)
            applyFilters();
        }
        
        // Populate year filter from data
        function populateYearFilter() {
            const years = new Set();
            
            allData.forEach(row => {
                if (row[0]) { // Column A (timestamp)
                    try {
                        // Try to parse date from multiple formats
                        let date;
                        
                        // Format: "6/16/2025 14:02:32"
                        if (row[0].includes('/') && row[0].includes(':')) {
                            const parts = row[0].split(' ');
                            if (parts.length === 2) {
                                const dateParts = parts[0].split('/');
                                if (dateParts.length === 3) {
                                    const month = parseInt(dateParts[0]);
                                    const day = parseInt(dateParts[1]);
                                    const year = parseInt(dateParts[2]);
                                    
                                    if (!isNaN(month) && !isNaN(day) && !isNaN(year)) {
                                        date = new Date(year, month - 1, day);
                                    }
                                }
                            }
                        } 
                        // Try standard date parsing as fallback
                        else {
                            date = new Date(row[0]);
                        }
                        
                        if (date && !isNaN(date.getTime())) {
                            const year = date.getFullYear();
                            // For Thai year (BE)
                            const thaiYear = year + 543;
                            years.add(thaiYear);
                            // Also add western year
                            years.add(year);
                        }
                    } catch (e) {
                        // Skip invalid dates
                        console.log("Error parsing date:", e);
                    }
                }
            });
            
            // Clear existing options except the first one
            while (yearFilterElement.options.length > 1) {
                yearFilterElement.remove(1);
            }
            
            // Add sorted years
            [...years].sort((a, b) => b - a).forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilterElement.appendChild(option);
            });
            
            // Set current year
            const currentDate = new Date();
            const currentThaiYear = currentDate.getFullYear() + 543;
            
            // Try to set Thai year first, if not available, try western year
            if ([...years].includes(currentThaiYear)) {
                yearFilterElement.value = currentThaiYear;
            } else if ([...years].includes(currentDate.getFullYear())) {
                yearFilterElement.value = currentDate.getFullYear();
            }
        }
        
        // Apply filters to data
        function applyFilters() {
            const selectedYear = yearFilterElement.value;
            const selectedMonth = monthFilterElement.value;
            
            filteredData = allData.filter(row => {
                if (!row[0]) return false; // Skip rows without timestamp
                
                try {
                    // Try to parse date from multiple formats
                    let date;
                    let month, year;
                    
                    // Format: "6/16/2025 14:02:32"
                    if (row[0].includes('/') && row[0].includes(':')) {
                        const parts = row[0].split(' ');
                        if (parts.length === 2) {
                            const dateParts = parts[0].split('/');
                            if (dateParts.length === 3) {
                                month = parseInt(dateParts[0]);
                                const day = parseInt(dateParts[1]);
                                year = parseInt(dateParts[2]);
                                
                                if (!isNaN(month) && !isNaN(day) && !isNaN(year)) {
                                    date = new Date(year, month - 1, day);
                                }
                            }
                        }
                    } 
                    // Try standard date parsing as fallback
                    else {
                        date = new Date(row[0]);
                        if (date && !isNaN(date.getTime())) {
                            month = date.getMonth() + 1;
                            year = date.getFullYear();
                        }
                    }
                    
                    if (!date || isNaN(date.getTime())) return false;
                    
                    let yearMatch = true;
                    if (selectedYear) {
                        // Check if the selected year is Thai year (BE)
                        if (selectedYear > 2500) {
                            yearMatch = (year + 543) == selectedYear;
                        } else {
                            yearMatch = year == selectedYear;
                        }
                    }
                    
                    let monthMatch = true;
                    if (selectedMonth) {
                        monthMatch = month == selectedMonth;
                    }
                    
                    return yearMatch && monthMatch;
                } catch (e) {
                    console.log("Error filtering date:", e);
                    return false;
                }
            });
            
            // Sort by timestamp (newest first)
            filteredData.sort((a, b) => {
                try {
                    // Try to parse dates from multiple formats
                    let dateA, dateB;
                    
                    // Format: "6/16/2025 14:02:32"
                    if (a[0].includes('/') && a[0].includes(':')) {
                        const parts = a[0].split(' ');
                        if (parts.length === 2) {
                            const dateParts = parts[0].split('/');
                            const timeParts = parts[1].split(':');
                            
                            if (dateParts.length === 3 && timeParts.length >= 2) {
                                const month = parseInt(dateParts[0]) - 1;
                                const day = parseInt(dateParts[1]);
                                const year = parseInt(dateParts[2]);
                                const hours = parseInt(timeParts[0]);
                                const minutes = parseInt(timeParts[1]);
                                const seconds = timeParts.length > 2 ? parseInt(timeParts[2]) : 0;
                                
                                dateA = new Date(year, month, day, hours, minutes, seconds);
                            }
                        }
                    }
                    
                    if (b[0].includes('/') && b[0].includes(':')) {
                        const parts = b[0].split(' ');
                        if (parts.length === 2) {
                            const dateParts = parts[0].split('/');
                            const timeParts = parts[1].split(':');
                            
                            if (dateParts.length === 3 && timeParts.length >= 2) {
                                const month = parseInt(dateParts[0]) - 1;
                                const day = parseInt(dateParts[1]);
                                const year = parseInt(dateParts[2]);
                                const hours = parseInt(timeParts[0]);
                                const minutes = parseInt(timeParts[1]);
                                const seconds = timeParts.length > 2 ? parseInt(timeParts[2]) : 0;
                                
                                dateB = new Date(year, month, day, hours, minutes, seconds);
                            }
                        }
                    }
                    
                    // Fallback to standard date parsing
                    if (!dateA || isNaN(dateA.getTime())) {
                        dateA = new Date(a[0]);
                    }
                    
                    if (!dateB || isNaN(dateB.getTime())) {
                        dateB = new Date(b[0]);
                    }
                    
                    if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) {
                        return 0;
                    }
                    
                    return dateB - dateA;
                } catch (e) {
                    console.log("Error sorting dates:", e);
                    return 0;
                }
            });
            
            renderTable();
        }
        
        // Render table with filtered data
        function renderTable() {
            tableBodyElement.innerHTML = '';
            
            if (filteredData.length === 0) {
                noDataElement.classList.remove('d-none');
                return;
            }
            
            noDataElement.classList.add('d-none');
            
            filteredData.forEach((row, index) => {
                const tr = document.createElement('tr');
                
                // Column 1: ID (Column E)
                const tdId = document.createElement('td');
                tdId.textContent = row[4] || 'ไม่ระบุ'; // Column E (index 4)
                tr.appendChild(tdId);
                
                // Column 2: Inspector (Column AT)
                const tdInspector = document.createElement('td');
                tdInspector.textContent = row[45] || 'ไม่ระบุ'; // Column AT (index 45)
                tr.appendChild(tdInspector);
                
                // Column 3: Actions
                const tdActions = document.createElement('td');
                tdActions.className = 'text-center';
                
                // View button
                const viewBtn = document.createElement('button');
                viewBtn.className = 'btn btn-sm btn-info action-btn me-2';
                viewBtn.innerHTML = '<i class="bi bi-eye-fill"></i>';
                viewBtn.title = 'ดูรายละเอียด';
                viewBtn.addEventListener('click', () => showDetailModal(row, index));
                tdActions.appendChild(viewBtn);
                
                // Edit button
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-sm btn-warning action-btn me-2';
                editBtn.innerHTML = '<i class="bi bi-pencil-fill"></i>';
                editBtn.title = 'แก้ไข';
                editBtn.addEventListener('click', () => showEditModal(row, index));
                tdActions.appendChild(editBtn);
                
                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-sm btn-danger action-btn';
                deleteBtn.innerHTML = '<i class="bi bi-trash-fill"></i>';
                deleteBtn.title = 'ลบข้อมูล';
                deleteBtn.addEventListener('click', () => showDeleteConfirmation(index));
                tdActions.appendChild(deleteBtn);
                
                tr.appendChild(tdActions);
                tableBodyElement.appendChild(tr);
            });
        }
        
        // Show detail modal
        function showDetailModal(row, index) {
            detailModalBodyElement.innerHTML = '';
            
            // Basic info
            const basicInfo = document.createElement('div');
            basicInfo.className = 'mb-4';
            basicInfo.innerHTML = `
                <h5 class="section-title"><i class="bi bi-info-circle-fill"></i> ข้อมูลทั่วไป</h5>
                <div class="row detail-row">
                    <div class="col-md-4 detail-label"><i class="bi bi-calendar-check"></i> วันที่ตรวจสอบ:</div>
                    <div class="col-md-8 detail-value">${formatDate(row[0])}</div>
                </div>
                <div class="row detail-row">
                    <div class="col-md-4 detail-label"><i class="bi bi-upc-scan"></i> ID:</div>
                    <div class="col-md-8 detail-value">${row[4] || 'ไม่ระบุ'}</div>
                </div>
                <div class="row detail-row">
                    <div class="col-md-4 detail-label"><i class="bi bi-person-badge"></i> ผู้ตรวจสอบ:</div>
                    <div class="col-md-8 detail-value">${row[45] || 'ไม่ระบุ'}</div>
                </div>
            `;
            detailModalBodyElement.appendChild(basicInfo);
            
            // Create sections for each tier
            const tiers = [
                { name: 'ชั้นที่ 1', columns: columnDefinitions.tier1, icon: 'bi-1-circle-fill' },
                { name: 'ชั้นที่ 2', columns: columnDefinitions.tier2, icon: 'bi-2-circle-fill' },
                { name: 'ชั้นที่ 3', columns: columnDefinitions.tier3, icon: 'bi-3-circle-fill' },
                { name: 'ชั้นที่ 4', columns: columnDefinitions.tier4, icon: 'bi-4-circle-fill' }
            ];
            
            tiers.forEach(tier => {
                const tierSection = document.createElement('div');
                tierSection.className = 'mb-4';
                
                let tierContent = `<h5 class="section-title"><i class="${tier.icon}"></i> ${tier.name}</h5>`;
                
                tier.columns.forEach(column => {
                    const colIndex = getColumnIndex(column.id);
                    let value = row[colIndex] || '';
                    
                    // Standardize display format for all types
                    if (value === '✔') {
                        value = 'มี';
                    } else if (value === '') {
                        value = 'ไม่มี';
                    }
                    
                    tierContent += `
                        <div class="row detail-row">
                            <div class="col-md-6 detail-label"><i class="${column.icon}"></i> ${column.name}:</div>
                            <div class="col-md-6 detail-value">${value}</div>
                        </div>
                    `;
                });
                
                tierSection.innerHTML = tierContent;
                detailModalBodyElement.appendChild(tierSection);
            });
            
            // Additional info
            const additionalInfo = document.createElement('div');
            additionalInfo.className = 'mb-3';
            additionalInfo.innerHTML = `
                <h5 class="section-title"><i class="bi bi-card-checklist"></i> ข้อมูลเพิ่มเติม</h5>
                <div class="row detail-row">
                    <div class="col-md-4 detail-label"><i class="bi bi-pen-fill"></i> เซ็นต์ชื่อ:</div>
                    <div class="col-md-8 detail-value">${row[46] || 'ไม่ระบุ'}</div>
                </div>
            `;
            detailModalBodyElement.appendChild(additionalInfo);
            
            detailModal.show();
        }
        
        // Show edit modal
        function showEditModal(row, index) {
            editFormContentElement.innerHTML = '';
            editRowIndexElement.value = index;
            
            // Basic info (read-only)
            const basicInfo = document.createElement('div');
            basicInfo.className = 'mb-3';
            basicInfo.innerHTML = `
                <h5 class="section-title"><i class="bi bi-info-circle-fill"></i> ข้อมูลทั่วไป</h5>
                <div class="row mb-2">
                    <div class="col-md-4">
                        <label class="form-label"><i class="bi bi-calendar-check"></i> วันที่ตรวจสอบ</label>
                        <input type="text" class="form-control form-control-sm" value="${formatDate(row[0])}" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label"><i class="bi bi-upc-scan"></i> ID</label>
                        <input type="text" class="form-control form-control-sm" value="${row[4] || ''}" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label"><i class="bi bi-person-badge"></i> ผู้ตรวจสอบ</label>
                        <input type="text" class="form-control form-control-sm" name="AT" value="${row[45] || ''}">
                    </div>
                </div>
            `;
            editFormContentElement.appendChild(basicInfo);
            
            // Create sections for each tier
            const tiers = [
                { name: 'ชั้นที่ 1', columns: columnDefinitions.tier1, icon: 'bi-1-circle-fill' },
                { name: 'ชั้นที่ 2', columns: columnDefinitions.tier2, icon: 'bi-2-circle-fill' },
                { name: 'ชั้นที่ 3', columns: columnDefinitions.tier3, icon: 'bi-3-circle-fill' },
                { name: 'ชั้นที่ 4', columns: columnDefinitions.tier4, icon: 'bi-4-circle-fill' }
            ];
            
            tiers.forEach(tier => {
                const tierSection = document.createElement('div');
                tierSection.className = 'mb-3';
                
                let tierContent = `<h5 class="section-title"><i class="${tier.icon}"></i> ${tier.name}</h5><div class="row">`;
                
                tier.columns.forEach(column => {
                    const colIndex = getColumnIndex(column.id);
                    const value = row[colIndex] || '';
                    
                    if (column.type === 'check') {
                        tierContent += `
                            <div class="col-md-6 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${column.id}" id="${column.id}" ${value === '✔' ? 'checked' : ''}>
                                    <label class="form-check-label" for="${column.id}">
                                        <i class="${column.icon} me-1"></i> ${column.name}
                                    </label>
                                </div>
                            </div>
                        `;
                    } else if (column.type === 'number') {
                        tierContent += `
                            <div class="col-md-6 mb-2">
                                <label class="form-label"><i class="${column.icon}"></i> ${column.name}</label>
                                <input type="number" class="form-control form-control-sm" name="${column.id}" value="${value || '0'}">
                            </div>
                        `;
                    } else {
                        tierContent += `
                            <div class="col-md-6 mb-2">
                                <label class="form-label"><i class="${column.icon}"></i> ${column.name}</label>
                                <input type="text" class="form-control form-control-sm" name="${column.id}" value="${value || ''}">
                            </div>
                        `;
                    }
                });
                
                tierContent += `</div>`;
                tierSection.innerHTML = tierContent;
                editFormContentElement.appendChild(tierSection);
            });
            
            // Additional info
            const additionalInfo = document.createElement('div');
            additionalInfo.className = 'mb-3';
            additionalInfo.innerHTML = `
                <h5 class="section-title"><i class="bi bi-card-checklist"></i> ข้อมูลเพิ่มเติม</h5>
                <div class="row">
                    <div class="col-md-12 mb-2">
                        <label class="form-label"><i class="bi bi-pen-fill"></i> เซ็นต์ชื่อ</label>
                        <input type="text" class="form-control form-control-sm" name="AU" value="${row[46] || ''}">
                    </div>
                </div>
            `;
            editFormContentElement.appendChild(additionalInfo);
            
            editModal.show();
        }
        
        // Show delete confirmation modal
        function showDeleteConfirmation(index) {
            deleteRowIndex = index;
            deletePasswordElement.value = '';
            passwordErrorElement.style.display = 'none';
            passwordModal.show();
        }
        
        // Confirm delete with password
        function confirmDelete() {
            const password = deletePasswordElement.value;
            
            if (password === '1234') {
                passwordModal.hide();
                deleteData(deleteRowIndex);
            } else {
                passwordErrorElement.style.display = 'block';
                deletePasswordElement.focus();
            }
        }
        
        // Delete data
        async function deleteData(index) {
            showLoading();
            hideError();
            
            try {
                const row = filteredData[index];
                const rowIndex = allData.findIndex(r => {
                    try {
                        // Compare timestamps
                        return r[0] === row[0];
                    } catch (e) {
                        return false;
                    }
                });
                
                if (rowIndex === -1) {
                    throw new Error('ไม่พบข้อมูลที่ต้องการลบ');
                }
                
                // Prepare data for API
                const apiData = {
                    action: 'delete',
                    timestamp: row[0] // Use timestamp to identify the row
                };
                
                // Try to delete via API
                let deleteSuccess = false;
                
                try {
                    // Method 1: Direct fetch
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(apiData)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            deleteSuccess = true;
                        }
                    }
                } catch (error) {
                    console.log("Delete method 1 failed:", error);
                }
                
                // Update local data regardless of API success
                allData.splice(rowIndex, 1);
                filteredData.splice(index, 1);
                
                // Show success message and update UI
                if (deleteSuccess) {
                    alert('ลบข้อมูลสำเร็จ และอัปเดตไปยังฐานข้อมูล');
                } else {
                    alert('ลบข้อมูลสำเร็จในแอปพลิเคชัน แต่ไม่สามารถอัปเดตฐานข้อมูลได้');
                }
                
                renderTable();
                
            } catch (error) {
                console.error('Error deleting data:', error);
                showError('เกิดข้อผิดพลาดในการลบข้อมูล: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Save changes from edit form
        async function saveChanges() {
            showLoading();
            hideError();
            
            try {
                const index = parseInt(editRowIndexElement.value);
                const row = filteredData[index];
                const rowIndex = allData.findIndex(r => {
                    try {
                        // Compare timestamps
                        return r[0] === row[0];
                    } catch (e) {
                        return false;
                    }
                });
                
                if (rowIndex === -1) {
                    throw new Error('ไม่พบข้อมูลที่ต้องการแก้ไข');
                }
                
                // Collect form data
                const formData = new FormData(document.getElementById('editForm'));
                const updatedData = {};
                
                // Process form data
                for (const [name, value] of formData.entries()) {
                    if (name.length === 2) { // Column ID (e.g., 'AT')
                        const colIndex = getColumnIndex(name);
                        
                        // Handle checkboxes
                        if (document.querySelector(`input[name="${name}"]`).type === 'checkbox') {
                            updatedData[colIndex] = value === 'on' ? '✔' : '';
                        } else {
                            updatedData[colIndex] = value;
                        }
                    }
                }
                
                // Update data in memory
                Object.keys(updatedData).forEach(colIndex => {
                    allData[rowIndex][colIndex] = updatedData[colIndex];
                    filteredData[index][colIndex] = updatedData[colIndex];
                });
                
                // Prepare data for API
                const apiData = {
                    action: 'update',
                    timestamp: row[0], // Use timestamp to identify the row
                    data: updatedData
                };
                
                // Try to update via API
                let updateSuccess = false;
                
                try {
                    // Method 1: Direct fetch
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(apiData)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            updateSuccess = true;
                        }
                    }
                } catch (error) {
                    console.log("Update method 1 failed:", error);
                }
                
                // Show success message and update UI
                if (updateSuccess) {
                    alert('บันทึกข้อมูลสำเร็จ และอัปเดตไปยังฐานข้อมูล');
                } else {
                    alert('บันทึกข้อมูลสำเร็จในแอปพลิเคชัน แต่ไม่สามารถอัปเดตฐานข้อมูลได้');
                }
                
                editModal.hide();
                renderTable();
                
            } catch (error) {
                console.error('Error saving data:', error);
                showError('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Helper function to get column index from column ID
        function getColumnIndex(columnId) {
            // Convert column ID (e.g., 'A', 'B', 'AA', 'AB') to index (0, 1, 26, 27)
            let index = 0;
            
            if (columnId.length === 1) {
                index = columnId.charCodeAt(0) - 65; // 'A' -> 0, 'B' -> 1, etc.
            } else if (columnId.length === 2) {
                index = (columnId.charCodeAt(0) - 64) * 26 + (columnId.charCodeAt(1) - 65);
            }
            
            return index;
        }
        
        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return 'ไม่ระบุ';
            
            try {
                // Try to parse date from multiple formats
                let date;
                
                // Format: "6/16/2025 14:02:32"
                if (dateString.includes('/') && dateString.includes(':')) {
                    const parts = dateString.split(' ');
                    if (parts.length === 2) {
                        const dateParts = parts[0].split('/');
                        const timeParts = parts[1].split(':');
                        
                        if (dateParts.length === 3 && timeParts.length >= 2) {
                            const month = parseInt(dateParts[0]);
                            const day = parseInt(dateParts[1]);
                            const year = parseInt(dateParts[2]);
                            const hours = parseInt(timeParts[0]);
                            const minutes = parseInt(timeParts[1]);
                            
                            if (!isNaN(month) && !isNaN(day) && !isNaN(year) && 
                                !isNaN(hours) && !isNaN(minutes)) {
                                
                                // Format as Thai date
                                const thaiYear = year + 543; // Convert to Buddhist Era
                                const hoursStr = hours.toString().padStart(2, '0');
                                const minutesStr = minutes.toString().padStart(2, '0');
                                
                                const thaiMonths = [
                                    'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                                    'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
                                ];
                                
                                return `${day} ${thaiMonths[month-1]} ${thaiYear} ${hoursStr}:${minutesStr} น.`;
                            }
                        }
                    }
                }
                
                // Fallback to standard date parsing
                date = new Date(dateString);
                if (date && !isNaN(date.getTime())) {
                    const day = date.getDate();
                    const month = date.getMonth();
                    const year = date.getFullYear();
                    const hours = date.getHours();
                    const minutes = date.getMinutes();
                    
                    // Format as Thai date
                    const thaiYear = year + 543; // Convert to Buddhist Era
                    const hoursStr = hours.toString().padStart(2, '0');
                    const minutesStr = minutes.toString().padStart(2, '0');
                    
                    const thaiMonths = [
                        'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                        'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
                    ];
                    
                    return `${day} ${thaiMonths[month]} ${thaiYear} ${hoursStr}:${minutesStr} น.`;
                }
                
                // If all parsing fails, return the original string
                return dateString;
            } catch (e) {
                console.log("Error formatting date:", e);
                return dateString;
            }
        }
        
        // Show loading overlay
        function showLoading() {
            loadingElement.style.display = 'flex';
        }
        
        // Hide loading overlay
        function hideLoading() {
            loadingElement.style.display = 'none';
        }
        
        // Show error message
        function showError(message) {
            errorTextElement.textContent = message;
            errorMessageElement.style.display = 'block';
        }
        
        // Hide error message
        function hideError() {
            errorMessageElement.style.display = 'none';
        }
        
        // Update connection status
        function updateConnectionStatus(type, message) {
            connectionStatusElement.className = 'connection-status ' + type;
            connectionStatusElement.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle-fill' : type === 'error' ? 'exclamation-triangle-fill' : 'hourglass-split'} me-1"></i> ${message}`;
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'957bea24c0ac4b65',t:'MTc1MTI2ODE2OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
